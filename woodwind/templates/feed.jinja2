{% extends "base.jinja2" %}
{% block head %}

<script src="http://code.jquery.com/jquery-2.1.3.min.js"></script>
<script>

function attachListeners() {
    $("#older-link").click(function(evt) {
        evt.preventDefault();
        $.get(this.href, function(result) {
            $(".pager").replaceWith(
                $("article,.pager", $(result)));
            attachListeners();
        });
    });
    $(".reply-form").css('display', 'none');
    $(".show-reply-form").click(function(evt) {
        var a = $(this);
        evt.preventDefault();
        $(".reply-form", a.parent()).css('display', 'inherit');
        a.css('display', 'none');
    });    

}

$(attachListeners);

</script>

{% endblock head %}

{% block header %}
  {% if current_user.is_authenticated() %}
    <form action="{{ url_for('.subscribe') }}" method="POST">
      <input type="text" id="origin" name="origin" placeholder="Feed URL" />
      <button type="submit" id="subscribe">Subscribe</button>
    </form>
  {% endif %}
{% endblock header %}

{% block body %}

  {% for entry in entries %}
    <article>
      <header>
        {% if entry.author_photo %}
          <img src="{{entry.author_photo}}"/>
        {% endif %}
        {% if entry.author_name %}
          {{ entry.author_name }} -
        {% endif %}
        {{ entry.feed.name }}
      </header>
      {% if entry.title %}
        <h1>{{ entry.title }}</h1>
      {% endif %}
      {% if entry.content %}
        <div>
          {{ entry.content_cleaned() }}
        </div>
      {% endif %}
      <footer>
        <a href="{{ entry.permalink }}">{{ entry.published }}</a>

        <form action="{{ current_user.micropub_endpoint }}" method="POST">
          <input type="hidden" name="access_token" value="{{current_user.access_token}}"/>
          <input type="hidden" name="h" value="entry"/>
          <input type="hidden" name="like-of" value="{{ entry.permalink }}"/>
          <button type="submit">Like</button>
        </form>

        <a href="#" class="show-reply-form">Reply</a>
        
        <form class="reply-form" action="{{ current_user.micropub_endpoint }}" method="POST">
          <input type="hidden" name="access_token" value="{{current_user.access_token}}"/>
          <input type="hidden" name="h" value="entry"/>
          <input type="hidden" name="in-reply-to" value="{{ entry.permalink }}"/>
          <textarea name="content"></textarea>
          <button type="submit">Reply</button>
        </form>

      </footer>
    </article>
  {% endfor %}

  {% if entries %}
    <div class="pager">
      <a id="older-link" href="{{ url_for(request.endpoint, page=page+1)}}">Older</a>
    </div>
  {% endif %}

{% endblock body %}
